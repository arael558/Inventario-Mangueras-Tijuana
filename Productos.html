<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Productos | StockPro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color:#f8fafc;
      color:#1e293b;
      display:flex;
      height:100vh;
      overflow:hidden;
    }
    /* Sidebar */
    .sidebar {
      width:250px;
      background:white;
      border-right:1px solid #e2e8f0;
      padding:24px 0;
      display:flex; flex-direction:column;
    }
    .logo {
      display:flex; align-items:center; gap:12px;
      padding:0 24px; margin-bottom:32px;
    }
    .logo-icon {
      width:40px; height:40px; border-radius:12px;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:700; font-size:18px;
    }
    .logo-text { font-size:24px; font-weight:700; color:#6366f1; }
    .nav-menu { padding:0 16px; }
    .nav-item {
      display:flex; align-items:center; gap:12px;
      padding:12px 16px; margin:4px 0; border-radius:12px;
      color:#64748b; text-decoration:none; font-weight:500;
      transition:all .2s; cursor:pointer;
    }
    .nav-item:hover { background:#f1f5f9; color:#334155; }
    .nav-item.active { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; }
    .nav-icon { width:20px; height:20px; }
    /* Main */
    .main-content { flex:1; background:#f8fafc; overflow-y:auto; }
    .header {
      background:white; padding:20px 32px; border-bottom:1px solid #e2e8f0;
      display:flex; justify-content:space-between; align-items:center;
    }
    .search-container { flex:1; max-width:400px; position:relative; }
    .search-input {
      width:100%; padding:12px 16px 12px 48px; border:1px solid #e2e8f0;
      border-radius:12px; background:#f8fafc; font-size:14px; color:#1e293b;
    }
    .search-input::placeholder { color:#94a3b8; }
    .search-input:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.1); }
    .search-icon { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:#94a3b8; }
    .user-section { display:flex; align-items:center; gap:12px; }
    .user-name { font-weight:600; }
    .user-avatar {
      width:40px; height:40px; border-radius:50%;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:600; font-size:14px;
    }
    /* Content */
    .page-content { padding:32px; }
    .page-header { margin-bottom:24px; }
    .page-title { font-size:28px; font-weight:700; margin-bottom:6px; }
    .page-subtitle { color:#64748b; }
    /* Stats small */
    .stats-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px; margin:20px 0 24px;
    }
    .stat-card {
      background:white; padding:16px 20px; border-radius:16px;
      border:1px solid #e2e8f0; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.05); transition:all .2s;
    }
    .stat-card:hover { transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,0,0,.1); }
    .stat-icon {
      width:44px; height:44px; border-radius:12px;
      display:flex; align-items:center; justify-content:center; color:white;
    }
    .stat-icon.blue { background:linear-gradient(135deg,#6366f1,#8b5cf6); }
    .stat-icon.orange { background:linear-gradient(135deg,#f59e0b,#f97316); }
    .stat-icon.green { background:linear-gradient(135deg,#10b981,#34d399); }
    .stat-label { font-size:12px; font-weight:600; color:#64748b; text-transform:uppercase; margin-bottom:2px; }
    .stat-value { font-size:24px; font-weight:700; }
    /* Product search & buttons */
    .product-search { display:flex; gap:12px; align-items:center; margin:6px 0 18px; }
    .product-search .input {
      flex:1; padding:12px 16px; border:1px solid #e2e8f0; border-radius:12px; font-size:14px;
    }
    .btn { padding:10px 16px; border:none; border-radius:12px; font-weight:600; cursor:pointer; display:flex; gap:8px; align-items:center; }
    .btn-primary { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; }
    .btn-outline { background:white; color:#475569; border:1px solid #e2e8f0; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    /* Table */
    .table-section { background:#fff; border:1px solid #e2e8f0; border-radius:20px; overflow:hidden; }
    .table-header { padding:20px 24px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
    .table-title { font-size:18px; font-weight:600; }
    table { width:100%; border-collapse:collapse; }
    th {
      text-align:left; padding:14px 24px; background:#f8fafc; color:#475569;
      font-size:12px; text-transform:uppercase; border-bottom:1px solid #e2e8f0;
    }
    td { padding:14px 24px; border-bottom:1px solid #f1f5f9; }
    tr:hover { background:#fafbfc; }
    /* Acciones */
    .action-buttons { display:flex; gap:12px; justify-content:center; align-items:center; }
    .action-buttons i { width:20px; height:20px; color:#334155; cursor:pointer; transition:transform .15s, color .2s; }
    .action-buttons i:hover { transform:scale(1.08); color:#6366f1; }
    /* Pagination */
    .pagination { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#fff; }
    .pager-controls { display:flex; gap:8px; align-items:center; }
    .pager-btn { padding:8px 12px; border:1px solid #e2e8f0; background:#fff; border-radius:10px; cursor:pointer; }
    .pager-btn:disabled { opacity:.5; cursor:not-allowed; }
    .rows-info { color:#64748b; font-size:13px; }
    .page-size { padding:8px 10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; }
    @media (max-width: 768px) {
      .sidebar { width:60px; }
      .logo-text, .nav-text { display:none; }
      th, td { padding:12px 14px; }
      .stats-grid { grid-template-columns:1fr; }
    }
    .muted { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">S</div>
      <div class="logo-text">StockPro</div>
    </div>
    <nav class="nav-menu">
      <a class="nav-item" href="#"><i data-lucide="layout-dashboard" class="nav-icon"></i><span class="nav-text">Dashboard</span></a>
      <a class="nav-item active" href="#"><i data-lucide="package" class="nav-icon"></i><span class="nav-text">Productos</span></a>
      <a class="nav-item" href="#"><i data-lucide="log-in" class="nav-icon"></i><span class="nav-text">Entradas</span></a>
      <a class="nav-item" href="#"><i data-lucide="log-out" class="nav-icon"></i><span class="nav-text">Salidas</span></a>
      <a class="nav-item" href="#"><i data-lucide="bar-chart-2" class="nav-icon"></i><span class="nav-text">Reportes</span></a>
      <a class="nav-item" href="#"><i data-lucide="users" class="nav-icon"></i><span class="nav-text">Proveedores</span></a>
      <a class="nav-item" href="#"><i data-lucide="settings" class="nav-icon"></i><span class="nav-text">Configuración</span></a>
    </nav>
  </div>

  <div class="main-content">
    <div class="header">
      <div class="search-container">
        <i data-lucide="search" class="search-icon"></i>
        <input type="text" class="search-input" placeholder="Buscar productos, SKU o categoría..." />
      </div>
      <div class="user-section">
        <span class="user-name">Carlos Vizcain</span>
        <div class="user-avatar">CV</div>
      </div>
    </div>

    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">Productos</h1>
        <p class="page-subtitle">Gestiona tu inventario y controla existencias, costos y valor total.</p>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><i data-lucide="package"></i></div>
          <div><div class="stat-label">Productos Totales</div><div class="stat-value" id="totalProducts">0</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange"><i data-lucide="alert-triangle"></i></div>
          <div><div class="stat-label">Stock Bajo</div><div class="stat-value" id="lowStock">0</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green"><i data-lucide="dollar-sign"></i></div>
          <div><div class="stat-label">Valor Total</div><div class="stat-value" id="totalValue">$0.00</div></div>
        </div>
      </div>

      <!-- Product controls -->
      <div class="product-search">
        <input id="productSearch" class="input" type="text" placeholder="🔍 Buscar por código o descripción..." />
        <button id="btnImport" class="btn btn-outline"><i data-lucide="file-up"></i> Importar CSV</button>
        <input id="csvInput" type="file" accept=".csv" style="display:none" />
        <button id="btnTemplate" class="btn btn-outline"><i data-lucide="download"></i> Plantilla</button>
        <button class="btn btn-primary"><i data-lucide="plus"></i> Agregar Producto</button>
      </div>
      <div class="muted">Formato recomendado CSV: <b>Código, Descripción, Stock Actual, Costo Unitario</b>. (Opcional: Valor Inventario)</div>

      <!-- Table -->
      <div class="table-section" style="margin-top:12px;">
        <div class="table-header">
          <h2 class="table-title">Inventario de Productos</h2>
          <div class="pager-controls">
            <label class="muted" for="pageSize">Filas:</label>
            <select id="pageSize" class="page-size">
              <option>25</option>
              <option selected>50</option>
              <option>100</option>
              <option>200</option>
            </select>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Descripción</th>
              <th>Stock Actual</th>
              <th>Costo Unitario</th>
              <th>Valor Inventario</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="productsTable"></tbody>
        </table>
        <div class="pagination">
          <div class="rows-info" id="rowsInfo">0 filas</div>
          <div class="pager-controls">
            <button id="prevBtn" class="pager-btn">Anterior</button>
            <span class="muted" id="pageLabel">1 / 1</span>
            <button id="nextBtn" class="pager-btn">Siguiente</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    lucide.createIcons();

    // State
    let products = [];      // full dataset
    let filtered = [];      // filtered dataset
    let currentPage = 1;
    let pageSize = 50;

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function parseNumber(x) {
      if (x === undefined || x === null) return 0;
      if (typeof x === 'number') return x;
      const s = String(x).replace(/\$/g,'').replace(/,/g,'').trim();
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function formatMoney(n) {
      return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 });
    }

    function normalizeRow(row) {
      const code = row['Código'] ?? row['Cod. Producto'] ?? row['Cod Producto'] ?? row['code'] ?? row['codigo'] ?? row['Cod'] ?? '';
      const description = row['Descripción'] ?? row['Descripcion'] ?? row['description'] ?? '';
      const stockStr = row['Stock Actual'] ?? row['Stock'] ?? row['Cantidad Actual'] ?? row['Cantidad'] ?? row['Existencia'] ?? 0;
      const unitStr = row['Costo Unitario'] ?? row['Costo'] ?? row['Precio Unitario'] ?? 0;
      const valueStr = row['Valor Inventario'] ?? row['Costo Inventario'] ?? row['Valor'] ?? 0;
      let stock = parseNumber(stockStr);
      let unitCost = parseNumber(unitStr);
      let value = parseNumber(valueStr);
      if (!value) value = (stock * unitCost);
      if (!unitCost && stock) unitCost = value / stock;
      return { code: String(code).trim(), description: String(description).trim(), stock, unitCost };
    }

    function computeStatus(stock) {
      if (stock <= 0) return 'Sin stock';
      if (stock < 5) return 'Stock bajo';
      return 'En stock';
    }

    function render() {
      // filter
      const term = ($('#productSearch')?.value || '').toLowerCase();
      filtered = !term ? [...products] :
        products.filter(p => p.code.toLowerCase().includes(term) || p.description.toLowerCase().includes(term));

      // pagination
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, total);
      const pageRows = filtered.slice(start, end);

      const tbody = $('#productsTable');
      tbody.innerHTML = '';
      pageRows.forEach(p => {
        const value = p.stock * p.unitCost;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.code}</td>
          <td>${p.description}</td>
          <td>${p.stock}</td>
          <td>${formatMoney(p.unitCost)}</td>
          <td>${formatMoney(value)}</td>
          <td>${computeStatus(p.stock)}</td>
          <td>
            <div class="action-buttons">
              <i data-lucide="eye" title="Ver"></i>
              <i data-lucide="edit" title="Editar"></i>
              <i data-lucide="trash-2" title="Eliminar"></i>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update stats (global)
      const globalLowStock = products.filter(p => p.stock > 0 && p.stock < 5).length;
      const globalValue = products.reduce((acc, p) => acc + p.stock * p.unitCost, 0);

      $('#totalProducts').textContent = products.length;
      $('#lowStock').textContent = globalLowStock;
      $('#totalValue').textContent = formatMoney(globalValue);

      // pager UI
      $('#rowsInfo').textContent = total ? `Mostrando ${start+1}-${end} de ${total}` : '0 filas';
      $('#pageLabel').textContent = `${currentPage} / ${totalPages}`;
      $('#prevBtn').disabled = currentPage <= 1;
      $('#nextBtn').disabled = currentPage >= totalPages;

      lucide.createIcons();
    }

    function loadCSVFile(file) {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          try {
            const rows = results.data;
            const mapped = rows.map(normalizeRow).filter(r => r.code && r.description);
            products = mapped;
            currentPage = 1;
            render();
          } catch (e) {
            alert('Error al procesar el CSV: ' + e.message);
          }
        },
        error: (err) => alert('No se pudo leer el CSV: ' + err)
      });
    }

    function downloadTemplate() {
      const csv = 'Código,Descripción,Stock Actual,Costo Unitario\n41FS-04,Adaptadores Latón SERIE FLARE 45,11,39.50\n';
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'plantilla_productos.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Demo mínima para ver contenido inicial (puedes borrar esto si cargas CSV)
    products = [
      { code: "41FS-04", description: "Adaptadores Latón SERIE FLARE 45", stock: 11, unitCost: 39.50 },
      { code: "41FS-05", description: "Adaptadores Latón SERIE FLARE 45", stock: 7, unitCost: 49.00 },
      { code: "41FS-06", description: "Adaptadores Latón SERIE FLARE 45", stock: 26, unitCost: 67.70 },
      { code: "41FS-08", description: "Adaptadores Latón SERIE FLARE 45", stock: 4, unitCost: 102.00 },
      { code: "41FS-10", description: "Adaptadores Latón SERIE FLARE 45", stock: 16, unitCost: 170.00 },
      { code: "41FS-12", description: "Adaptadores Latón SERIE FLARE 45", stock: 9, unitCost: 290.00 }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      render();
      $('#productSearch').addEventListener('input', () => { currentPage = 1; render(); });
      $('#prevBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; render(); } });
      $('#nextBtn').addEventListener('click', () => { currentPage++; render(); });
      $('#pageSize').addEventListener('change', (e) => { pageSize = parseInt(e.target.value, 10) || 50; currentPage = 1; render(); });
      $('#btnImport').addEventListener('click', () => $('#csvInput').click());
      $('#csvInput').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) loadCSVFile(f);
        e.target.value = '';
      });
      $('#btnTemplate').addEventListener('click', downloadTemplate);
    });
  </script>
</body>
</html>
